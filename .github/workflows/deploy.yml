name: validate-and-deploy

on:
  pull_request:
    branches: [ dev ]
  push:
    branches: [ main ]


jobs:
  # Test on Pull Request
  validate:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: Install dependencies
        run: |
          pip install -U pip
          pip install -r requirements.txt

      - name: Run unit tests
        run: pytest tests/

  # Terraform Infrastructure Deploy
  terraform-deploy:
    if: github.event_name == 'push'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: 1.5.5

      - name: Terraform Init
        working-directory: ./nyc_311_terraform
        run: terraform init

      - name: Terraform Plan
        working-directory: ./nyc_311_terraform
        run: |
          terraform plan -out=tfplan \
            -var="aws_access_key=${{ secrets.AWS_ACCESS_KEY_ID }}" \
            -var="aws_secret_key=${{ secrets.AWS_SECRET_ACCESS_KEY }}" \
            -var="aws_session_token=${{ secrets.AWS_SESSION_TOKEN }}"

      - name: Terraform Apply
        working-directory: ./nyc_311_terraform
        run: terraform apply -auto-approve tfplan

  daily-etl:
    if: github.event_name == 'push'
    runs-on: ubuntu-latest

    needs: terraform-deploy
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: Install dependencies
        run: |
          pip install -U pip
          pip install -r requirements.txt


#      - name: Run fetch_and_upload.py
#        run: python scripts/fetch_and_upload.py
#        env:
#          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
#          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
#          AWS_SESSION_TOKEN: ${{ secrets.AWS_SESSION_TOKEN }}

      - name: Upload etl.py to S3
        run: |
          aws s3 cp scripts/etl.py s3://cdac-final-project-data/ETL_script_for_glue/etl.py
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_SESSION_TOKEN: ${{ secrets.AWS_SESSION_TOKEN }}

      - name: Run AWS Glue Job
        run: |
          aws glue start-job-run \
            --job-name daily-etl-job \
            --region us-east-1
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_SESSION_TOKEN: ${{ secrets.AWS_SESSION_TOKEN }}

      - name: Run AWS Glue Crawler
        run: |
          aws glue start-crawler \
            --name crawler-etl-output \
            --region us-east-1
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_SESSION_TOKEN: ${{ secrets.AWS_SESSION_TOKEN }}
